{"code":"/**\r\n * Created by championswimmer on 18/07/17.\r\n */\r\nimport merge from 'lodash.merge';\r\nimport MockStorage from './MockStorage';\r\nimport SimplePromiseQueue from './SimplePromiseQueue';\r\n/**\r\n * A class that implements the vuex persistence.\r\n */\r\nvar VuexPersistence = (function () {\r\n    /**\r\n     * Create a {@link VuexPersistence} object.\r\n     * Use the <code>plugin</code> function of this class as a\r\n     * Vuex plugin.\r\n     * @param {PersistOptions} options\r\n     */\r\n    function VuexPersistence(options) {\r\n        var _this = this;\r\n        // tslint:disable-next-line:variable-name\r\n        this._mutex = new SimplePromiseQueue();\r\n        /**\r\n         * Creates a subscriber on the store. automatically is used\r\n         * when this is used a vuex plugin. Not for manual usage.\r\n         * @param store\r\n         */\r\n        this.subscriber = function (store) {\r\n            return function (handler) { return store.subscribe(handler); };\r\n        };\r\n        this.key = ((options.key != null) ? options.key : 'vuex');\r\n        this.subscribed = false;\r\n        if (options.storage != null) {\r\n            this.storage = options.storage;\r\n        }\r\n        else {\r\n            this.storage = new MockStorage();\r\n        }\r\n        if (options.restoreState != null) {\r\n            this.restoreState = options.restoreState;\r\n        }\r\n        else {\r\n            this.restoreState = function (key, storage) {\r\n                storage = storage || _this.storage;\r\n                var retrievedState = storage.getItem(key);\r\n                if (typeof retrievedState.then === 'function') {\r\n                    return Promise.resolve(retrievedState\r\n                        .then(function (value) {\r\n                        if (typeof value === 'string') {\r\n                            return JSON.parse(value || '{}');\r\n                        }\r\n                        else {\r\n                            return value || {};\r\n                        }\r\n                    }));\r\n                }\r\n                else {\r\n                    return retrievedState;\r\n                }\r\n            };\r\n        }\r\n        this.saveState = ((options.saveState != null)\r\n            ? options.saveState\r\n            : (function (key, state, storage) {\r\n                return Promise.resolve((storage || _this.storage).setItem(key, // Second argument is state _object_ if localforage, stringified otherwise\r\n                (((storage && storage._config && storage._config.name) === 'localforage')\r\n                    ? merge({}, state)\r\n                    : JSON.stringify(state))));\r\n            }));\r\n        /**\r\n         * How this works is -\r\n         *  1. If there is options.reducer function, we use that, if not;\r\n         *  2. We check options.modules;\r\n         *    1. If there is no options.modules array, we use entire state in reducer\r\n         *    2. Otherwise, we create a reducer that merges all those state modules that are\r\n         *        defined in the options.modules[] array\r\n         * @type {((state: S) => {}) | ((state: S) => S) | ((state: any) => {})}\r\n         */\r\n        this.reducer = ((options.reducer != null)\r\n            ? options.reducer\r\n            : ((options.modules == null)\r\n                ? (function (state) { return state; })\r\n                : (function (state) {\r\n                    return options.modules.reduce(function (a, i) {\r\n                        return merge(a, (_a = {}, _a[i] = state[i], _a));\r\n                        var _a;\r\n                    }, {});\r\n                })));\r\n        this.filter = ((options.filter != null)\r\n            ? options.filter\r\n            : (function (mutation) { return true; }));\r\n        this.strictMode = options.strictMode || false;\r\n        this.RESTORE_MUTATION = function RESTORE_MUTATION(state, savedState) {\r\n            state = merge(state, savedState);\r\n        };\r\n        this.plugin = function (store) {\r\n            Promise.resolve(_this.restoreState(_this.key, _this.storage)).then(function (savedState) {\r\n                /**\r\n                 * If in strict mode, do only via mutation\r\n                 */\r\n                if (_this.strictMode) {\r\n                    store.commit('RESTORE_MUTATION', savedState);\r\n                }\r\n                else {\r\n                    store.replaceState(merge(store.state, savedState));\r\n                }\r\n                _this.subscriber(store)(function (mutation, state) {\r\n                    if (_this.filter(mutation)) {\r\n                        _this._mutex.enqueue(Promise.resolve(_this.saveState(_this.key, _this.reducer(state), _this.storage)));\r\n                    }\r\n                });\r\n                _this.subscribed = true;\r\n            });\r\n        };\r\n    }\r\n    return VuexPersistence;\r\n}());\r\nexport { VuexPersistence };\r\nexport { MockStorage };\r\nexport default VuexPersistence;\r\n//# sourceMappingURL=index.js.map","map":{"version":3,"file":"index.js","sourceRoot":"","sources":["src/index.ts"],"names":[],"mappings":"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"},"dts":{"name":"/Users/championswimmer/Development/Personal/Vue/vuex-persist/index.d.ts","text":"import { Mutation, Payload, Plugin } from 'vuex';\r\nimport MockStorage from './MockStorage';\r\nexport interface AsyncStorage {\r\n    getItem<T>(key: string): Promise<T>;\r\n    setItem<T>(key: string, data: T): Promise<T>;\r\n}\r\n/**\r\n * Options to be used to construct a {@link VuexPersistence} object\r\n */\r\nexport interface PersistOptions<S> {\r\n    /**\r\n     * Window.Storage type object. Default is localStorage\r\n     */\r\n    storage?: Storage | AsyncStorage;\r\n    /**\r\n     * Method to retrieve state from persistence\r\n     * @param key\r\n     * @param [storage]\r\n     */\r\n    restoreState?: (key: string, storage?: Storage) => Promise<S> | S;\r\n    /**\r\n     * Method to save state into persistence\r\n     * @param key\r\n     * @param state\r\n     * @param [storage]\r\n     */\r\n    saveState?: (key: string, state: {}, storage?: Storage) => Promise<void> | void;\r\n    /**\r\n     * Function to reduce state to the object you want to save.\r\n     * Be default, we save the entire state.\r\n     * You can use this if you want to save only a portion of it.\r\n     * @param state\r\n     */\r\n    reducer?: (state: S) => {};\r\n    /**\r\n     * Key to use to save the state into the storage\r\n     */\r\n    key?: string;\r\n    /**\r\n     * Method to filter which mutations will trigger state saving\r\n     * Be default returns true for all mutations.\r\n     * Check mutations using <code>mutation.type</code>\r\n     * @param mutation object of type {@link Payload}\r\n     */\r\n    filter?: (mutation: Payload) => boolean;\r\n    /**\r\n     * Names of modules that you want to persist.\r\n     * If you create your custom {@link PersistOptions.reducer} function,\r\n     * then that will override filter behaviour, not this argument\r\n     */\r\n    modules?: string[];\r\n    /**\r\n     * Set this to true to support\r\n     * <a href=\"https://vuex.vuejs.org/en/strict.html\">Vuex Strict Mode</a>\r\n     */\r\n    strictMode?: boolean;\r\n}\r\n/**\r\n * A class that implements the vuex persistence.\r\n */\r\nexport declare class VuexPersistence<S, P extends Payload> implements PersistOptions<S> {\r\n    storage: Storage | AsyncStorage;\r\n    restoreState: (key: string, storage?: AsyncStorage | Storage) => Promise<S> | S;\r\n    saveState: (key: string, state: {}, storage?: AsyncStorage | Storage) => Promise<void> | void;\r\n    reducer: (state: S) => {};\r\n    key: string;\r\n    filter: (mutation: Payload) => boolean;\r\n    modules: string[];\r\n    strictMode: boolean;\r\n    /**\r\n     * The plugin function that can be used inside a vuex store.\r\n     */\r\n    plugin: Plugin<S>;\r\n    /**\r\n     * A mutation that can be used to restore state\r\n     * Helpful if we are running in strict mode\r\n     */\r\n    RESTORE_MUTATION: Mutation<S>;\r\n    subscribed: boolean;\r\n    private _mutex;\r\n    /**\r\n     * Create a {@link VuexPersistence} object.\r\n     * Use the <code>plugin</code> function of this class as a\r\n     * Vuex plugin.\r\n     * @param {PersistOptions} options\r\n     */\r\n    constructor(options: PersistOptions<S>);\r\n    /**\r\n     * Creates a subscriber on the store. automatically is used\r\n     * when this is used a vuex plugin. Not for manual usage.\r\n     * @param store\r\n     */\r\n    private subscriber;\r\n}\r\nexport { MockStorage };\r\nexport default VuexPersistence;\r\n"}}
