{"code":"/**\r\n * Created by championswimmer on 18/07/17.\r\n */\r\nimport merge from 'lodash.merge';\r\nimport MockStorage from './MockStorage';\r\nimport SimplePromiseQueue from './SimplePromiseQueue';\r\n/**\r\n * A class that implements the vuex persistence.\r\n */\r\nvar VuexPersistence = (function () {\r\n    /**\r\n     * Create a {@link VuexPersistence} object.\r\n     * Use the <code>plugin</code> function of this class as a\r\n     * Vuex plugin.\r\n     * @param {PersistOptions} options\r\n     */\r\n    function VuexPersistence(options) {\r\n        var _this = this;\r\n        // tslint:disable-next-line:variable-name\r\n        this._mutex = new SimplePromiseQueue();\r\n        /**\r\n         * Creates a subscriber on the store. automatically is used\r\n         * when this is used a vuex plugin. Not for manual usage.\r\n         * @param store\r\n         */\r\n        this.subscriber = function (store) {\r\n            return function (handler) { return store.subscribe(handler); };\r\n        };\r\n        this.key = ((options.key != null) ? options.key : 'vuex');\r\n        this.subscribed = false;\r\n        this.storage = ((options.storage != null) ? options.storage : (new MockStorage()));\r\n        this.restoreState = ((options.restoreState != null)\r\n            ? options.restoreState\r\n            : (function (key, storage) {\r\n                return Promise.resolve((storage || _this.storage).getItem(key))\r\n                    .then(function (value) {\r\n                    return typeof value === 'string' // If string, parse, or else, just return\r\n                        ? JSON.parse(value || '{}')\r\n                        : (value || {});\r\n                });\r\n            }));\r\n        this.saveState = ((options.saveState != null)\r\n            ? options.saveState\r\n            : (function (key, state, storage) {\r\n                return Promise.resolve((storage || _this.storage).setItem(key, // Second argument is state _object_ if localforage, stringified otherwise\r\n                (((storage && storage._config && storage._config.name) === 'localforage')\r\n                    ? merge({}, state)\r\n                    : JSON.stringify(state))));\r\n            }));\r\n        /**\r\n         * How this works is -\r\n         *  1. If there is options.reducer function, we use that, if not;\r\n         *  2. We check options.modules;\r\n         *    1. If there is no options.modules array, we use entire state in reducer\r\n         *    2. Otherwise, we create a reducer that merges all those state modules that are\r\n         *        defined in the options.modules[] array\r\n         * @type {((state: S) => {}) | ((state: S) => S) | ((state: any) => {})}\r\n         */\r\n        this.reducer = ((options.reducer != null)\r\n            ? options.reducer\r\n            : ((options.modules == null)\r\n                ? (function (state) { return state; })\r\n                : (function (state) {\r\n                    return options.modules.reduce(function (a, i) {\r\n                        return merge(a, (_a = {}, _a[i] = state[i], _a));\r\n                        var _a;\r\n                    }, {});\r\n                })));\r\n        this.filter = ((options.filter != null)\r\n            ? options.filter\r\n            : (function (mutation) { return true; }));\r\n        this.strictMode = options.strictMode || false;\r\n        this.RESTORE_MUTATION = function RESTORE_MUTATION(state, savedState) {\r\n            state = merge(state, savedState);\r\n        };\r\n        this.plugin = function (store) {\r\n            Promise.resolve(_this.restoreState(_this.key, _this.storage)).then(function (savedState) {\r\n                /**\r\n                 * If in strict mode, do only via mutation\r\n                 */\r\n                if (_this.strictMode) {\r\n                    store.commit('RESTORE_MUTATION', savedState);\r\n                }\r\n                else {\r\n                    store.replaceState(merge(store.state, savedState));\r\n                }\r\n                _this.subscriber(store)(function (mutation, state) {\r\n                    if (_this.filter(mutation)) {\r\n                        _this._mutex.enqueue(Promise.resolve(_this.saveState(_this.key, _this.reducer(state), _this.storage)));\r\n                    }\r\n                });\r\n                _this.subscribed = true;\r\n            });\r\n        };\r\n    }\r\n    return VuexPersistence;\r\n}());\r\nexport { VuexPersistence };\r\nexport { MockStorage };\r\nexport default VuexPersistence;\r\n//# sourceMappingURL=index.js.map","map":{"version":3,"file":"index.js","sourceRoot":"","sources":["src/index.ts"],"names":[],"mappings":"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"},"dts":{"name":"/Users/championswimmer/Development/Personal/Vue/vuex-persist/index.d.ts","text":"import { Mutation, Payload, Plugin } from 'vuex';\r\nimport MockStorage from './MockStorage';\r\nimport { AsyncStorage } from './AsyncStorage';\r\nimport { PersistOptions } from './PersistOptions';\r\n/**\r\n * A class that implements the vuex persistence.\r\n */\r\nexport declare class VuexPersistence<S, P extends Payload> implements PersistOptions<S> {\r\n    storage: Storage | AsyncStorage;\r\n    restoreState: (key: string, storage?: AsyncStorage | Storage) => Promise<S> | S;\r\n    saveState: (key: string, state: {}, storage?: AsyncStorage | Storage) => Promise<void> | void;\r\n    reducer: (state: S) => {};\r\n    key: string;\r\n    filter: (mutation: Payload) => boolean;\r\n    modules: string[];\r\n    strictMode: boolean;\r\n    /**\r\n     * The plugin function that can be used inside a vuex store.\r\n     */\r\n    plugin: Plugin<S>;\r\n    /**\r\n     * A mutation that can be used to restore state\r\n     * Helpful if we are running in strict mode\r\n     */\r\n    RESTORE_MUTATION: Mutation<S>;\r\n    subscribed: boolean;\r\n    private _mutex;\r\n    /**\r\n     * Create a {@link VuexPersistence} object.\r\n     * Use the <code>plugin</code> function of this class as a\r\n     * Vuex plugin.\r\n     * @param {PersistOptions} options\r\n     */\r\n    constructor(options: PersistOptions<S>);\r\n    /**\r\n     * Creates a subscriber on the store. automatically is used\r\n     * when this is used a vuex plugin. Not for manual usage.\r\n     * @param store\r\n     */\r\n    private subscriber;\r\n}\r\nexport { MockStorage, AsyncStorage, PersistOptions };\r\nexport default VuexPersistence;\r\n"}}
